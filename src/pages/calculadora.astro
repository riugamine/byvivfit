---
import Layout from "../layouts/Layout.astro";
import { Image } from "astro:assets";
import CallToAction from "../components/common/CallToAction.astro";
---

<Layout title="Calculadora de Macros - byVivifit">
  <section
    class="pt-20 lg:pt-24 pb-8 lg:pb-12 bg-gradient-to-r from-coral to-salmon text-white"
  >
    <div class="container mx-auto px-4">
      <div class="text-center max-w-3xl mx-auto">
        <h1
          class="text-2xl sm:text-3xl lg:text-4xl font-opensauce font-bold mb-4"
        >
          Calculadora de Macros
        </h1>
        <p class="text-lg font-agrandir mb-6">
          Calcula tus macronutrientes ideales y descubre tu plan nutricional
          personalizado
        </p>
      </div>
    </div>
  </section>

  <section class="py-12 lg:py-16 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <!-- Formulario de Calculadora -->
        <form
          id="macrosForm"
          class="bg-white rounded-xl p-6 lg:p-8 shadow-lg border border-gray-100"
        >
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Datos B√°sicos -->
            <div class="space-y-4">
              <div>
                <label
                  class="block text-sm font-bold mb-2 font-opensauce"
                  for="sexo"
                >
                  <i class="fas fa-venus-mars text-coral mr-2"></i>
                  Sexo
                  <i
                    class="fas fa-info-circle text-gray-400 ml-1"
                    data-tippy-content="Tu sexo biol√≥gico es importante para calcular tu metabolismo basal"
                  ></i>
                </label>
                <select id="sexo" class="w-full p-3 border rounded-lg">
                  <option value="">Selecciona tu sexo biol√≥gico</option>
                  <option value="masculino">Masculino</option>
                  <option value="femenino">Femenino</option>
                </select>
              </div>

              <div>
                <label
                  class="block text-sm font-bold mb-2 font-opensauce"
                  for="actividad"
                >
                  <i class="fas fa-running text-coral mr-2"></i>
                  Nivel de Actividad
                  <i
                    class="fas fa-info-circle text-gray-400 ml-1"
                    data-tippy-content="Tu nivel de actividad f√≠sica semanal"
                  ></i>
                </label>
                <select id="actividad" class="w-full p-3 border rounded-lg">
                  <option value="1.2">Sedentario</option>
                  <option value="1.375">Ligeramente Activo</option>
                  <option value="1.55">Moderadamente Activo</option>
                  <option value="1.725">Muy Activo</option>
                </select>
              </div>

              <div>
                <label
                  class="block text-sm font-bold mb-2 font-opensauce"
                  for="peso"
                >
                  <i class="fas fa-weight text-coral mr-2"></i>
                  Peso (kg)
                </label>
                <input
                type="number"
                id="peso"
                class="w-full p-3 border rounded-lg"
                min="30"
                max="200"
                step="0.1"
                required
                placeholder="Ej: 70"
              />
              </div>

              <div>
                <label
                  class="block text-sm font-bold mb-2 font-opensauce"
                  for="altura"
                >
                  <i class="fas fa-ruler-vertical text-coral mr-2"></i>
                  Altura (cm)
                </label>
                <input
                type="number"
                id="altura"
                class="w-full p-3 border rounded-lg"
                min="140"
                max="220"
                step="1"
                required
                placeholder="Ej: 170"
              />
              </div>
            </div>

            <!-- Datos Adicionales -->
            <div class="space-y-4">
              <div>
                <label
                  class="block text-sm font-bold mb-2 font-opensauce"
                  for="edad"
                >
                  <i class="fas fa-birthday-cake text-coral mr-2"></i>
                  Edad
                </label>
                <input
                type="number"
                id="edad"
                class="w-full p-3 border rounded-lg"
                min="15"
                max="80"
                step="1"
                required
                placeholder="Ej: 25"
              />
              </div>

              <!-- Reemplazar el input de grasa por un select -->
              <div>
                <label
                  class="block text-sm font-bold mb-2 font-opensauce"
                  for="grasa"
                >
                  <i class="fas fa-percentage text-coral mr-2"></i>
                  Porcentaje de Grasa
                  <i
                    class="fas fa-info-circle text-gray-400 ml-1"
                    data-tippy-content="Selecciona el que m√°s se parezca a tu composici√≥n corporal actual"
                  ></i>
                </label>
                <select id="grasa" class="w-full p-3 border rounded-lg">
                  <option value="">Selecciona tu porcentaje</option>
                  <optgroup label="Mujeres">
                    <option value="14">12-14% - Atl√©tica</option>
                    <option value="17">15-17% - Fitness</option>
                    <option value="20">18-20% - Saludable</option>
                    <option value="23">21%-23% -  Normal</option>
                    <option value="26">24%-26% Por encima del promedio</option>
                    <option value="29">27%-29% No saludable</option>
                    <option value="30">30% o m√°s - Alto</option>
                  </optgroup>
                  <optgroup label="Hombres">
                    <option value="5">4-5% - Competici√≥n</option>
                    <option value="7">6-7% - Atl√©tico</option>
                    <option value="10">8-10% - Fitness</option>
                    <option value="11">11%-12% - Saludable</option>
                    <option value="15">13%-15% - Normal</option>
                    <option value="19">16%-19% - Por encima del promedio</option>
                    <option value="24">20%-24% - Alto</option>
                    <option value="25"
                      >25% o m√°s - No saludable </option
                    >
                  </optgroup>
                </select>
              </div>

              <div>
                <label
                  class="block text-sm font-bold mb-2 font-opensauce"
                  for="objetivo"
                >
                  <i class="fas fa-bullseye text-coral mr-2"></i>
                  Objetivo
                </label>
                <select id="objetivo" class="w-full p-3 border rounded-lg">
                  <option value="mantenimiento">Mantenimiento</option>
                  <option value="deficit_ligero">D√©ficit Ligero</option>
                  <option value="deficit_moderado">D√©ficit Moderado</option>
                  <option value="deficit_extremo">D√©ficit Extremo</option>
                  <option value="aumento_ligero">Aumento Ligero</option>
                  <option value="aumento_moderado">Aumento Moderado</option>
                  <option value="aumento_extremo">Aumento Extremo</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Im√°genes de Referencia -->
          <div class="mt-8">
            <h3 class="text-lg font-bold mb-4 font-opensauce">
              Referencia Visual de Porcentaje de Grasa
            </h3>
            <div id="imagenContainer" class="relative">
              <div id="placeholderText" class="text-center py-12 bg-gray-50 rounded-xl">
                <p class="text-gray-600 font-agrandir">
                  Selecciona tu sexo biol√≥gico para ver las referencias visuales
                </p>
              </div>
              <div id="imagenHombre" class="hidden">
                <Image
                  src="https://res.cloudinary.com/dhzl31kb8/image/upload/v1744229739/hombres_pgp4av.jpg"
                  alt="Referencia de porcentajes de grasa corporal para hombres"
                  width={1200}
                  height={800}
                  class="w-full rounded-xl shadow-lg"
                  format="webp"
                  quality={90}
                />
              </div>
              <div id="imagenMujer" class="hidden">
                <Image
                  src="https://res.cloudinary.com/dhzl31kb8/image/upload/v1744229739/mujeres_jhvqe4.jpg"
                  alt="Referencia de porcentajes de grasa corporal para mujeres"
                  width={1200}
                  height={800}
                  class="w-full rounded-xl shadow-lg"
                  format="webp"
                  quality={90}
                />
              </div>
            </div>
            <p class="text-sm text-gray-500 mt-2 text-center">
              * Las im√°genes son referencias aproximadas. Los porcentajes pueden
              variar seg√∫n factores individuales.
            </p>
          </div>
        </form>

        <!-- Resultados -->
        <div id="resultados" class="mt-8 hidden">
          <!-- Se llenar√° din√°micamente con JavaScript -->
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
          <button
            id="calcularBtn"
            class="px-8 py-3 bg-coral text-white rounded-full font-bold hover:bg-black transition duration-300"
          >
            <i class="fas fa-calculator mr-2"></i>
            Calcular Macros
          </button>
          <!-- Eliminar el bot√≥n descargarBtn -->
        </div>
      </div>
    </div>
  </section>

  <!-- Call to Action -->
  <CallToAction
    title="¬øQuieres un Plan Personalizado?"
    subtitle="Obt√©n una asesor√≠a completa y alcanza tus objetivos con un plan dise√±ado espec√≠ficamente para ti."
    buttonText="Conoce M√°s"
    buttonLink="/asesorias"
  />
</Layout>

<script>
  // Importaciones
  import tippy from "tippy.js";
  import "tippy.js/dist/tippy.css";
  import { Chart } from "chart.js/auto";

  // Tipos
  interface Macros {
    proteina: number;
    grasa: number;
    carbos: number;
  }

  interface ObjetivoFactores {
    [key: string]: number;
  }

  // Constantes
  const MAX_CALCULOS: number = 3;
  let calculosRealizados: number = 0;
  const FACTORES_OBJETIVO: ObjetivoFactores = {
    mantenimiento: 1,
    deficit_ligero: 0.85,
    deficit_moderado: 0.80,
    deficit_extremo: 0.70,
    aumento_ligero: 1.10,
    aumento_moderado: 1.05,
    aumento_extremo: 1.10,
  };

  const FACTORES_GRASA: ObjetivoFactores = {
    alto_en_grasas: 1.2,
    moderado_en_grasas: 1,
    balanceado_en_grasas: 0.8,
  };

  // Funciones de c√°lculo
  const calcularMasaMagra = (peso: number, grasa: number): number => {
    return peso * (1 - grasa / 100);
  };

  const calcularTMB = (masaMagra: number): number => {
    return 370 + (21.6 * masaMagra);
  };

  const calcularCalorias = (
    tmb: number,
    actividad: string,
    objetivo: string,
    sexo: string
  ): number => {
    // 1. Primero aplicamos el ajuste por sexo al TMB
    let caloriasTMB = tmb;
    if (sexo === "femenino") {
      caloriasTMB -= 160;
    } else if (sexo === "masculino") {
      caloriasTMB += 5;
    }
  
  // 2. Aplicamos el factor de actividad
  const caloriasConActividad = caloriasTMB * parseFloat(actividad);
  
    // 3. Finalmente aplicamos el objetivo para obtener el d√©ficit o super√°vit
    return Math.round(caloriasConActividad * FACTORES_OBJETIVO[objetivo]);
};

  const calcularMacros = (
    peso: number,
    calorias: number,
    objetivo: string
  ): Macros => {
    // Prote√≠nas: 2.4g por kg de peso corporal
    const proteina = Math.round(peso * 2.4);
    
    // Grasas: var√≠an seg√∫n el objetivo
    let factorGrasa = 0.8; // Balanceado por defecto
    
    if (objetivo.includes('deficit')) {
      factorGrasa = 1.0; // Moderado en grasas para d√©ficit
    } else if (objetivo.includes('aumento')) {
      factorGrasa = 1.2; // Alto en grasas para aumento
    }
    
    const grasa = Math.round(peso * factorGrasa);
    
    // Carbohidratos: calor√≠as restantes
    const caloriasProteinas = proteina * 4;
    const caloriasGrasas = grasa * 9;
    const caloriasRestantes = calorias - caloriasProteinas - caloriasGrasas;
    const carbos = Math.round(caloriasRestantes / 4);
  
    return { proteina, grasa, carbos };
  };

  // Funciones de UI
  const mostrarResultados = (calorias: number, macros: Macros): void => {
    const resultadosDiv: HTMLElement | null =
      document.getElementById("resultados");
    if (!resultadosDiv) return;

    resultadosDiv.innerHTML = `
      <div class="bg-white rounded-xl p-6 lg:p-8 shadow-lg border border-gray-100">
        <h2 class="text-2xl sm:text-3xl font-bold mb-8 font-opensauce text-center">
          Resultados de la Calculadora
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
          <!-- Gr√°fico -->
          <div class="bg-gray-50 p-6 rounded-lg flex justify-center items-center">
            <div class="w-full max-w-[400px]">
              <canvas id="macrosChart"></canvas>
            </div>
          </div>
          
          <!-- Resultados num√©ricos -->
          <div class="space-y-6">
            <div class="bg-gray-50 p-6 rounded-lg">
              <h3 class="text-xl font-bold mb-6 font-opensauce">Distribuci√≥n Diaria</h3>
              
              <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                  <span class="font-agrandir text-gray-700">Calor√≠as Totales</span>
                  <span class="text-2xl font-bold text-coral">${calorias} kcal</span>
                </div>
                
                <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                  <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-[#FF6B6B] mr-2"></div>
                    <span class="font-agrandir text-gray-700">Prote√≠na</span>
                  </div>
                  <span class="text-xl font-bold text-coral">${macros.proteina}g</span>
                </div>
                
                <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                  <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-[#4ECDC4] mr-2"></div>
                    <span class="font-agrandir text-gray-700">Carbohidratos</span>
                  </div>
                  <span class="text-xl font-bold text-coral">${macros.carbos}g</span>
                </div>
                
                <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                  <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-[#45B7D1] mr-2"></div>
                    <span class="font-agrandir text-gray-700">Grasas</span>
                  </div>
                  <span class="text-xl font-bold text-coral">${macros.grasa}g</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- A√±adir secci√≥n de newsletter -->
      <div class="mt-8 bg-gradient-to-r from-coral to-salmon p-6 rounded-xl text-white">
        <div class="text-center">
          <h3 class="text-xl font-bold mb-2 font-opensauce">¬øQuieres m√°s consejos nutricionales?</h3>
          <p class="mb-4">√önete a nuestro newsletter y recibe tips semanales, recetas saludables y gu√≠as exclusivas.</p>
          
          <form id="newsletterForm" class="max-w-md mx-auto">
            <div class="flex gap-2">
              <input 
                type="email" 
                id="newsletterEmail" 
                placeholder="Tu correo electr√≥nico" 
                class="flex-1 px-4 py-2 rounded-lg text-gray-800"
                required
              >
              <button 
                type="submit" 
                class="bg-black hover:bg-gray-800 px-6 py-2 rounded-lg transition duration-300"
              >
                Unirme
              </button>
            </div>
          </form>
        </div>
      </div>
    `;

    resultadosDiv.classList.remove("hidden");

    // Inicializar el gr√°fico
    const ctx = document.getElementById("macrosChart") as HTMLCanvasElement;

    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Prote√≠na", "Carbohidratos", "Grasas"],
        datasets: [
          {
            data: [macros.proteina * 4, macros.carbos * 4, macros.grasa * 9],
            backgroundColor: ["#FF6B6B", "#4ECDC4", "#45B7D1"],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              font: {
                family: "Agrandir",
              },
            },
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const label = context.label || "";
                const value = context.raw || 0;
                const percentage = Math.round(
                  (Number(value) /
                    context.dataset.data.reduce(
                      (a: number, b: number) => a + b,
                      0
                    )) *
                    100
                );
                return `${label}: ${percentage}%`;
              },
            },
          },
        },
      },
    });
  };

  // Event Listeners
  const calcularBtn = document.getElementById("calcularBtn");
  document.addEventListener('DOMContentLoaded', () => {
    const sexoSelect = document.getElementById("sexo") as HTMLSelectElement;
    const placeholderText = document.getElementById("placeholderText");
    const imagenHombre = document.getElementById("imagenHombre");
    const imagenMujer = document.getElementById("imagenMujer");

    if (sexoSelect) {
      sexoSelect.addEventListener("change", () => {
        const sexo = sexoSelect.value;
        
        if (!sexo) {
          placeholderText?.classList.remove('hidden');
          imagenHombre?.classList.add('hidden');
          imagenMujer?.classList.add('hidden');
          return;
        }

        placeholderText?.classList.add('hidden');
        
        if (sexo === "masculino") {
          imagenHombre?.classList.remove('hidden');
          imagenMujer?.classList.add('hidden');
        } else if (sexo === "femenino") {
          imagenHombre?.classList.add('hidden');
          imagenMujer?.classList.remove('hidden');
        }
      });
    }


  if (calcularBtn) {
    calcularBtn.addEventListener("click", (e: Event) => {
      e.preventDefault();

      if (calculosRealizados >= MAX_CALCULOS) {
        alert(
          "Has alcanzado el l√≠mite de c√°lculos permitidos. Por favor, refresca la p√°gina para continuar."
        );
        return;
      }

      // Get form elements
      const sexoSelect = document.getElementById("sexo") as HTMLSelectElement;
      const pesoInput = document.getElementById("peso") as HTMLInputElement;
      const alturaInput = document.getElementById("altura") as HTMLInputElement;
      const edadInput = document.getElementById("edad") as HTMLInputElement;
      const grasaSelect = document.getElementById("grasa") as HTMLSelectElement;
      const actividadSelect = document.getElementById("actividad") as HTMLSelectElement;
      const objetivoSelect = document.getElementById("objetivo") as HTMLSelectElement;

      // Validate all required fields are filled
      if (!sexoSelect.value || !pesoInput.value || !alturaInput.value || !edadInput.value || !grasaSelect.value) {
        alert("Por favor completa todos los campos requeridos");
        return;
      }

      // Parse values
      const sexo = sexoSelect.value;
      const peso = parseFloat(pesoInput.value);
      const altura = parseFloat(alturaInput.value);
      const edad = parseFloat(edadInput.value);
      const grasa = parseFloat(grasaSelect.value);
      const actividad = actividadSelect.value;
      const objetivo = objetivoSelect.value;

      // Validate ranges
      if (peso < 30 || peso > 200) {
        alert("Por favor ingresa un peso v√°lido entre 30 y 200 kg");
        return;
      }

      if (altura < 140 || altura > 220) {
        alert("Por favor ingresa una altura v√°lida entre 140 y 220 cm");
        return;
      }

      if (edad < 15 || edad > 80) {
        alert("Por favor ingresa una edad v√°lida entre 15 y 80 a√±os");
        return;
      }

      if (grasa < 3 || grasa > 40) {
        alert("Por favor selecciona un porcentaje de grasa v√°lido");
        return;
      }

      calculosRealizados++;
      if (calculosRealizados === MAX_CALCULOS) {
        calcularBtn.classList.add("opacity-50", "cursor-not-allowed");
      }

      const masaMagra = calcularMasaMagra(peso, grasa);
      console.log('üèãÔ∏è Masa Magra:', masaMagra, 'kg');

      const tmb = calcularTMB(masaMagra);
      console.log('üî• TMB (Tasa Metab√≥lica Basal):', tmb, 'kcal');

      const calorias = calcularCalorias(tmb, actividad, objetivo, sexo);
      console.log('üìä Detalles del c√°lculo de calor√≠as:', {
        tmb,
        factorActividad: actividad,
        objetivo,
        sexo,
        ajusteSexo: sexo === "femenino" ? "-160" : "+5",
        caloriasFinal: calorias
      });

      const macros = calcularMacros(peso, calorias, objetivo);
      console.log('üçñ Detalles de macros:', {
        peso,
        calorias,
        objetivo,
        proteina: {
          gramos: macros.proteina,
          calorias: macros.proteina * 4
        },
        grasa: {
          gramos: macros.grasa,
          calorias: macros.grasa * 9
        },
        carbos: {
          gramos: macros.carbos,
          calorias: macros.carbos * 4
        },
        caloriasTotales: (macros.proteina * 4) + (macros.grasa * 9) + (macros.carbos * 4)
      });

      mostrarResultados(calorias, macros);
    });
  }

  // Inicializar tooltips
  tippy("[data-tippy-content]");
});
</script>

<style>
  @media (max-width: 768px) {
    .grid-cols-1 > div {
      margin-bottom: 1.5rem;
    }
    #macrosChart {
      max-height: 300px;
    }
  }

  /* Add these new styles */
  img {
    max-width: 100%;
    height: auto;
    object-fit: contain;
  }

  @media (min-width: 640px) {
    img {
      object-fit: cover;
    }
  }
</style>
